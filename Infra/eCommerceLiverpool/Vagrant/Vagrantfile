time1 = Time.new
tat = "1"
tvt = "2"

puts ""
puts "---------------------------------------------------"
puts "--- Vagrant provisoner generated by Miguel Díaz ---"
puts "--- All rigths reserved 2108 \u00A9 12factor.mx ---"
puts "---------------------------------------------------"
puts "---    Vist us at https://www.12factor.mx       ---"
puts "---------------------------------------------------"
puts ""
puts "Starting Vagrant at: " + time1.inspect                
puts ""

require 'pp'

hosts = YAML.load_file('../Inventory/hosts.3.yml')
groups = YAML.load_file('../Inventory/groups.yml')

ga = Hash.new {|h,k| h[k]=[]}
ga1 = Hash.new {|h,k| h[k]=[]}

i = 1

puts "--- Generating the Ansible inventory groups ---"
puts ""
hosts.each do |va|
  len = va["ansible_inventory"]["groups"]["belongs_to"].length
  for j in 0..len -1
    if  ! (ga.has_key?(ga[va["ansible_inventory"]["groups"]["belongs_to"][j]]))
       ga[va["ansible_inventory"]["groups"]["belongs_to"][j]] 
    end 
  end  
end

puts "ga keys"
puts ga

hosts.each do |va|
  name = va["name"]
  len = va["ansible_inventory"]["groups"]["belongs_to"].length
  for k in 0..len -1
    if ! (ga.has_key?(ga[va["ansible_inventory"]["groups"]["belongs_to"][k]]))
       ga[va["ansible_inventory"]["groups"]["belongs_to"][k]] << name
    end 
  end  
end

puts "ga values"
puts ga

groups.each do |va|
  len = va["elements"].length
  for l in 0..len -1
    ga1[va["name"]] << va["elements"][l]
  end  
end

ga2 = ga1.merge(ga)

pp ga2

Vagrant.configure(2) do |config|

  config.vm.box = "ol68" #wls_admin_server_name
  config.vm.box_url = "https://yum.oracle.com/boxes/oraclelinux/ol68/ol68.box"

  hosts.each do |v|
    
    config.vm.define v["name"] do |machine|

      machine.vm.network "private_network", ip: v["ip"]
      
      machine.vm.provider "virtualbox" do |vb|
      
        vb.name = v["name"] 
        vb.memory = 512

        if v.has_key?('synced_folders')
          
          folders = v['synced_folders']
          
          folders.each do |folder|

            machine.vm.synced_folder folder['src'], folder['dest'], folder['options']

          end

        end
    
      end

      if i == hosts.count
        
        #puts ""
        #puts "--- Starting the Ansible provisioner ---"
        #puts ""

        #time3 = Time.new
        #puts "Starting at: " + time3.inspect                
        #puts ""

        config.vm.provision :ansible do |ansible|
           
          #fh = open ".vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory"
          #content = fh.read
          #fh.close  

          #puts ""
          #puts "--- Final Ansible inventory file ---"
          #puts ""
          #puts content
          #puts ""
   

          ansible.limit = "all"
          ansible.playbook = "../Ansible/main.1.yml"
          ansible.sudo = true
          ansible.config_file = "/etc/ansible/ansible.cfg"
          ansible.groups = ga2
          

        end
   
      end

      i = i + 1
      
    end

  end

#puts ""
#puts "--- Ending the Ansible provisioner ---"
#puts ""
#time4 = Time.new
#puts "Ending  at: " + time4.inspect                
#puts ""


#time2 = Time.new

#puts "Ending Vagrant at: " + time2.inspect                
#puts ""
#puts "---------------------------------------------------"
#puts "Timing Resume:"
#puts "---------------------------------------------------"
#puts "Total Vagrant time: " + tvt
#puts "Total Ansible time: " + tat
#puts "---------------------------------------------------"
#puts ""
#puts "---      Thanks & Enjoy your machines          ----"
#puts ""
#puts "---------------------------------------------------"
#puts "--- Vagrant provisoner generated by Miguel Díaz ---"
#puts "--- All rigths reserved 2108 \u00A9 12factor.mx ---"
#puts "---------------------------------------------------"
#puts "---    Vist us at https://www.12factor.mx       ---"
#puts "---------------------------------------------------"
#puts ""

end



       



